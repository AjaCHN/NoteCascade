# 游戏玩法规范

## 概览
NoteCascade 的核心游戏循环包括与音乐同步的下落音符、击键检测和评分。

## 渲染 (`/app/components/GameCanvas.tsx`)

### Canvas 设置
- 使用 HTML5 `<canvas>` 元素进行高性能渲染。
- `ResizeObserver` 确保画布始终与其容器大小匹配。

### 音符渲染（瀑布流）
- 音符从屏幕顶部向底部附近的“击键线”下落。
- 音符的垂直位置是根据其相对于歌曲 `currentTime` 的 `time` 计算的，并由 `pixelsPerSecond` 因子缩放。
- 水平位置和宽度是根据音符的 `midi` 音高计算的，并将其映射到可见的 `keyboardRange`。

### 击键检测
- 当用户按下按键（通过 MIDI、电脑键盘或触摸）时，游戏会检查在 `currentTime` 附近的一定时间窗口内，该特定 MIDI 音高是否有下落音符。
- **判定窗口**：
  - Perfect（完美）：±0.1 秒
  - Good（良好）：±0.2 秒
  - Miss（错过）：音符越过击键线而未被按下。
  - Wrong（错误）：按下了键，但判定窗口内没有音符。

### 视觉反馈
- **击键线**：击中音符时发光。
- **粒子**：成功击中时，小方块从击键线喷发。
- **波纹**：击键线上出现扩大的圆圈。
- **漂浮文字**：根据击键质量着色的“Perfect”、“Good”、“Miss”或“Wrong”文字从击键位置向上漂浮。
